#!/usr/bin/env python3

import sys
import argparse
import subprocess

from i3ipc import Connection

# Place your preferred icon name (or path) here. Leave empty ("") for no icon.
icon_enabled = "/home/anthony/.local/share/icons/cup-of-coffee-on.svg"
icon_disabled = "/home/anthony/.local/share/icons/cup-of-coffee-off.svg"

# The number of the signal to refresh the executor label, in range SIGTRMIN - SIGRTMAX (probably 34 - 64).
# You may check available range with `kill -l`.
sig_num = 38

i3 = Connection()

def get_pid(name):
    try:
        output = subprocess.check_output(["pidof","-s",name])
    except subprocess.CalledProcessError as e:
        return 0
    return int(output)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("-s",
                        "--switch",
                        action="store_true",
                        help="prevents/permit the system from entering an idle state")
    args = parser.parse_args()

    if args.switch:
        pid = get_pid("caffeinated")
        if pid == 0:
            p = subprocess.run("caffeinated -d", shell=True)
        else:
            p = subprocess.run("kill -s HUP {}".format(pid), shell=True)
        # Send refresh signal to nwg-panel
        subprocess.Popen('pkill -{} nwg-panel'.format(sig_num), shell=True,
                         stdout=subprocess.DEVNULL,
                         stderr=subprocess.STDOUT)
        sys.exit(0)

    icon = icon_disabled
    pid = get_pid("caffeinated")
    if pid != 0:
        icon = icon_enabled

    print("{}".format(icon))


if __name__ == '__main__':
    main()

